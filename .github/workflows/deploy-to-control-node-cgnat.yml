name: Deploy to Control Node (via Master Node and WireGuard)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      run: |
        set -e
        
        # Перевірка обов'язкових secrets
        if [ -z "${{ secrets.MASTER_NODE_PUBLIC_IP }}" ]; then
          echo "❌ Error: MASTER_NODE_PUBLIC_IP secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.MASTER_NODE_USER }}" ]; then
          echo "❌ Error: MASTER_NODE_USER secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.MASTER_NODE_SSH_KEY }}" ]; then
          echo "❌ Error: MASTER_NODE_SSH_KEY secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.CONTROL_NODE_LOCAL_IP }}" ]; then
          echo "❌ Error: CONTROL_NODE_LOCAL_IP secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.CONTROL_NODE_USER }}" ]; then
          echo "❌ Error: CONTROL_NODE_USER secret is not set"
          exit 1
        fi
        if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
          echo "❌ Error: DEPLOY_PATH secret is not set"
          exit 1
        fi
        
        echo "✅ All required secrets are set"
        
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        
        # SSH ключ для підключення до master-node (jump server)
        echo "${{ secrets.MASTER_NODE_SSH_KEY }}" > ~/.ssh/master_node_key
        chmod 600 ~/.ssh/master_node_key
        
        # Додаємо known_hosts
        ssh-keyscan -H ${{ secrets.MASTER_NODE_PUBLIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Створюємо SSH config для підключення через master-node до macmini7 через WireGuard
        cat > ~/.ssh/config << EOF
        Host master-node
          HostName ${{ secrets.MASTER_NODE_PUBLIC_IP }}
          User ${{ secrets.MASTER_NODE_USER }}
          Port ${MASTER_NODE_PORT:-22}
          IdentityFile ~/.ssh/master_node_key
          StrictHostKeyChecking no
          ServerAliveInterval 60
          ServerAliveCountMax 3
          
        Host control-node
          HostName ${{ secrets.CONTROL_NODE_LOCAL_IP }}
          User ${{ secrets.CONTROL_NODE_USER }}
          Port ${CONTROL_NODE_SSH_PORT:-22}
          ProxyCommand ssh -W %h:%p master-node
          StrictHostKeyChecking no
          ServerAliveInterval 60
          ServerAliveCountMax 3
          # Використовуємо SSH config з master-node для підключення до macmini7
          ForwardAgent no
        EOF
        chmod 600 ~/.ssh/config
        
        echo "✅ SSH config created successfully"
        echo "Master Node: ${{ secrets.MASTER_NODE_USER }}@${{ secrets.MASTER_NODE_PUBLIC_IP }}"
        echo "Control Node: ${{ secrets.CONTROL_NODE_USER }}@${{ secrets.CONTROL_NODE_LOCAL_IP }}"
      env:
        MASTER_NODE_PORT: ${{ secrets.MASTER_NODE_PORT || '22' }}
        CONTROL_NODE_SSH_PORT: ${{ secrets.CONTROL_NODE_SSH_PORT || '22' }}
        
    - name: Test connection to master-node
      run: |
        echo "Testing connection to master-node..."
        ssh -o ConnectTimeout=10 master-node "echo '✅ Connected to master-node' && hostname"
        
    - name: Test connection to control-node via WireGuard
      run: |
        echo "Testing connection to control-node via WireGuard tunnel..."
        # Виконуємо SSH команду через master-node
        # SSH автоматично використовує ~/.ssh/config, тому не потрібно вказувати -F
        ssh master-node "ssh -o ConnectTimeout=10 macmini7 'echo ✅ Connected to control-node && hostname' || \
          ssh -o ConnectTimeout=10 ${{ secrets.CONTROL_NODE_USER }}@${{ secrets.CONTROL_NODE_LOCAL_IP }} 'echo ✅ Connected to control-node && hostname'"
        
    - name: Deploy files to control node via WireGuard tunnel
      run: |
        # Створюємо директорію на control node через master-node
        # SSH автоматично використовує ~/.ssh/config на master-node
        ssh master-node "ssh macmini7 'mkdir -p ${{ secrets.DEPLOY_PATH }}' || \
          ssh ${{ secrets.CONTROL_NODE_USER }}@${{ secrets.CONTROL_NODE_LOCAL_IP }} 'mkdir -p ${{ secrets.DEPLOY_PATH }}'"
        
        # Копіюємо файли: спочатку на master-node, потім на macmini7
        # Створюємо тимчасову директорію на master-node
        TEMP_DIR="/tmp/k3s-deploy-$$"
        ssh master-node "mkdir -p $TEMP_DIR"
        
        # Копіюємо файли на master-node
        rsync -avz --delete \
          -e "ssh -F ~/.ssh/config" \
          --exclude='.git' \
          --exclude='.cursor' \
          --exclude='*.local' \
          --exclude='.github' \
          ./ \
          master-node:$TEMP_DIR/
        
        # Копіюємо файли з master-node на macmini7 через WireGuard
        # Встановлюємо HOME та використовуємо абсолютний шлях до SSH config
        ssh master-node "HOME=/home/ubuntu rsync -avz --delete \
          -e '/usr/bin/ssh -F /home/ubuntu/.ssh/config' \
          $TEMP_DIR/ \
          macmini7:${{ secrets.DEPLOY_PATH }}/ && \
          rm -rf $TEMP_DIR"
        
    - name: Verify deployment
      run: |
        ssh master-node "ssh macmini7 'ls -la ${{ secrets.DEPLOY_PATH }} && echo Deployment successful!' || \
          ssh ${{ secrets.CONTROL_NODE_USER }}@${{ secrets.CONTROL_NODE_LOCAL_IP }} 'ls -la ${{ secrets.DEPLOY_PATH }} && echo Deployment successful!'"

