apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: monitoring
  labels:
    app: prometheus
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'k3s-cluster'
        replica: 'prometheus-0'

    scrape_configs:
      - job_name: 'prometheus'
        static_configs:
          - targets: ['localhost:9090']

      - job_name: 'kubernetes-apiservers'
        static_configs:
          - targets: ['192.168.2.19:6443']
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      - job_name: 'kubernetes-nodes'
        static_configs:
          - targets: ['10.0.10.10:10250', '10.0.10.20:10250', '192.168.2.19:10250']
        scheme: https
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      - job_name: 'node-exporter'
        static_configs:
          - targets: ['10.0.10.10:9100', '10.0.10.20:9100', '192.168.2.19:9100']

      - job_name: 'cadvisor'
        static_configs:
          - targets: ['10.0.10.10:10250', '10.0.10.20:10250', '192.168.2.19:10250']
        scheme: https
        tls_config:
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - source_labels: [__address__]
            target_label: __metrics_path__
            replacement: /metrics/cadvisor
        scrape_interval: 30s
        scrape_timeout: 20s

      - job_name: 'kube-state-metrics'
        static_configs:
          - targets: ['10.42.2.24:8080']
        scrape_interval: 30s
        scrape_timeout: 20s

      # SNMP Exporter для моніторингу роутерів
      - job_name: 'snmp-routers'
        scrape_interval: 60s  # Інтервал опитування роутерів (60 секунд)
        scrape_timeout: 60s  # Збільшено timeout для SNMP запитів
        static_configs:
          # Роутер vrn625 (UCG Ultra with UniFi OS)
          - targets:
            - 192.168.2.1
            labels:
              router_name: 'vrn625'
              router_ip: '192.168.2.1'
              router_model: 'UCG-Ultra'
              router_type: 'UniFi-OS'
          # Роутер syhiv17 (EdgeRouter-X)
          - targets:
            - 192.168.1.1
            labels:
              router_name: 'syhiv17'
              router_ip: '192.168.1.1'
              router_model: 'EdgeRouter-X'
              router_type: 'EdgeOS'
        metrics_path: /snmp
        params:
          module: [router]
        relabel_configs:
          - source_labels: [__address__]
            target_label: __param_target
          # Використовуємо специфічний модуль для кожного роутера
          - source_labels: [router_name]
            target_label: __param_module
            regex: vrn625
            replacement: unifi_ucg
          - source_labels: [router_name]
            regex: syhiv17
            target_label: __param_module
            replacement: edgerouter_x
          - source_labels: [__param_target]
            target_label: instance
          - target_label: __address__
            replacement: snmp-exporter:9116
